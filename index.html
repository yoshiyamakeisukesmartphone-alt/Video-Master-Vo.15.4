<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Video Master Vo.15.3</title>
<link rel="manifest" href="manifest.json">
<style>
  :root{
    --bg:#0f1724; --fg:#e6eef6; --panel:#0b1220; --accent:#06b6d4; --danger:#ff3b30;
  }
  [data-theme="light"]{
    --bg:#f5f7fb; --fg:#0b2233; --panel:#ffffff; --accent:#0b63ff; --danger:#e11d48;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  .wrap{max-width:1200px;margin:12px auto;padding:10px;display:flex;flex-wrap:wrap;gap:12px;box-sizing:border-box}
  h1{width:100%;text-align:center;margin:8px 0 6px 0}
  .panel{background:var(--panel);padding:10px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.28);width:320px;box-sizing:border-box}
  .panel.full{width:100%;max-width:760px}
  input[type=text]{width:100%;padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:var(--fg);box-sizing:border-box}
  ul{list-style:none;margin:8px 0;padding:0;max-height:320px;overflow:auto}
  li{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;margin:6px 0;background:rgba(255,255,255,0.02);user-select:none}
  .name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:grab}
  button{background:var(--accent);border:none;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
  .small{font-size:13px;padding:4px 8px}
  .danger{background:var(--danger)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px}
  audio{width:100%;max-width:760px;border-radius:10px;background:#000;display:block;margin:8px auto}
  .topbar{display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:8px;flex-wrap:wrap}
  .hint{font-size:13px;color:rgba(255,255,255,0.6);margin-top:6px}
  @media(max-width:900px){.panel{width:100%}.panel.full{order:3}}
</style>
<!-- Sortable for drag&drop reordering -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body data-theme="dark">
  <h1>ğŸ§ Video Master Vo.15.3</h1>

  <div class="topbar">
    <button id="themeToggle" class="small">ğŸŒ— ãƒ†ãƒ¼ãƒåˆ‡æ›¿</button>
    <label class="small"><input type="checkbox" id="tempMode"> ä¸€æ™‚å†ç”Ÿï¼ˆä¿å­˜ã—ãªã„ï¼‰</label>
    <button id="clearTemp" class="small">ä¸€æ™‚ã‚­ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢</button>
  </div>

  <div class="wrap">
    <div class="panel">
      <h3>ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</h3>
      <input id="playlistSearch" type="text" placeholder="ğŸ” ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆæ¤œç´¢">
      <ul id="playlistList"></ul>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="addPlaylist">ï¼‹ æ–°è¦</button>
        <button id="exportBtn" class="small">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      </div>
      <div class="hint">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã¯IndexedDBã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>
    </div>

    <div class="panel">
      <h3>ãƒ•ã‚¡ã‚¤ãƒ«</h3>
      <input id="fileSearch" type="text" placeholder="ğŸ” æ›²ã‚’æ¤œç´¢">
      <ul id="fileList"></ul>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <label for="fileInput" style="background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:8px;cursor:pointer">ï¼‹ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ </label>
        <input id="fileInput" type="file" accept="audio/*" multiple style="display:none">
        <button id="addFilesBtn" class="small">è¿½åŠ </button>
      </div>
      <div class="hint">ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã¹æ›¿ãˆå¯èƒ½ã€‚ä¿å­˜ã—ãŸããªã„ã¨ãã¯ã€Œä¸€æ™‚å†ç”Ÿã€ã‚’ãƒã‚§ãƒƒã‚¯ã€‚</div>
    </div>

    <div class="panel full">
      <!-- playsinline / webkit-playsinline ã‚’ä»˜ã‘ã¦ iOS ã®æŒ™å‹•ã‚’æ”¹å–„ -->
      <audio id="player" controls playsinline webkit-playsinline></audio>
      <div class="controls">
        <button id="prevBtn">â® å‰</button>
        <button id="playBtn">â–¶ å†ç”Ÿ</button>
        <button id="pauseBtn">â¸ åœæ­¢</button>
        <button id="nextBtn">â­ æ¬¡</button>
        <button id="loopBtn">ğŸ” ãƒ«ãƒ¼ãƒ—ï¼šã‚ªãƒ³</button>
        <button id="fullscreenBtn">â›¶ å…¨ç”»é¢</button>
      </div>
      <div class="hint">GitHub Pages ã«ã‚¢ãƒƒãƒ—ã—ã¦ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã™ã‚‹ã¨ PWA ã¨ã—ã¦ä½¿ãˆã¾ã™ï¼ˆAndroid ã§å¼·åŠ›ï¼‰ã€‚</div>
    </div>
  </div>

<script>
/*  Video Master Vo.15.3 - modified for improved background playback on iPad
    - Keep playing when device locks by keeping an active AudioContext and a silent looping buffer
    - Works with audio-only files (base64 dataURI supported)
    - Still uses <audio> for controls & iOS compatibility, but maintains a WebAudio "keep-alive" source
    - Ready to upload as index.html
*/

// state
let playlists = []; // {name, files:[{name,data}]}
let currentPlaylist = null;
let currentIndex = 0;
let loopMode = true;
let tempQueue = [];
let db = null;
let audioCtx = null;
let mediaSource = null;
let keepAliveSource = null; // silent buffer source to keep audio hardware active
let resumeOnReturn = false;
let hiddenEndedCheckTimer = null;

// IndexedDB setup
const openReq = indexedDB.open('VideoMaster_v15_3', 1);
openReq.onupgradeneeded = e => {
  db = e.target.result;
  if(!db.objectStoreNames.contains('playlists')) db.createObjectStore('playlists', {keyPath:'name'});
};
openReq.onsuccess = e => {
  db = e.target.result;
  loadPlaylists();
  const saved = localStorage.getItem('vm-theme');
  if(saved) document.documentElement.dataset.theme = saved;
};
openReq.onerror = e => console.error('IndexedDB error', e);

// DB helpers
function savePlaylists(){
  if(!db) return;
  const tx = db.transaction('playlists','readwrite');
  const store = tx.objectStore('playlists');
  store.clear();
  for(const p of playlists) store.put(p);
}
function loadPlaylists(){
  if(!db) return;
  const tx = db.transaction('playlists','readonly');
  const store = tx.objectStore('playlists');
  const getAll = store.getAll();
  getAll.onsuccess = () => {
    playlists = getAll.result || [];
    renderPlaylists();
    if(playlists.length>0 && !currentPlaylist) selectPlaylist(playlists[0].name);
  };
}

// rendering
function renderPlaylists(){
  const q = document.getElementById('playlistSearch').value.toLowerCase();
  const ul = document.getElementById('playlistList');
  ul.innerHTML = '';
  playlists.filter(p => p.name.toLowerCase().includes(q)).forEach(p => {
    const li = document.createElement('li');
    const span = document.createElement('span'); span.className='name'; span.textContent = p.name; span.onclick = ()=>selectPlaylist(p.name);
    const ren = document.createElement('button'); ren.textContent='âœï¸'; ren.className='small';
    ren.onclick = e => { e.stopPropagation(); const nn = prompt('æ–°ã—ã„ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå', p.name); if(nn){ p.name = nn; savePlaylists(); renderPlaylists(); } };
    const del = document.createElement('button'); del.textContent='Ã—'; del.className='danger';
    del.onclick = e => { e.stopPropagation(); if(confirm(`ã€Œ${p.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)){ playlists = playlists.filter(x=>x.name!==p.name); savePlaylists(); renderPlaylists(); if(currentPlaylist===p.name){ currentPlaylist=null; renderFiles(); } } };
    li.append(span, ren, del);
    ul.appendChild(li);
  });
  const tmp = document.createElement('li'); tmp.style.background='rgba(255,255,255,0.02)'; tmp.innerHTML = '<span class="name">â–¶ ä¸€æ™‚ã‚­ãƒ¥ãƒ¼ï¼ˆä¿å­˜ã•ã‚Œã¾ã›ã‚“ï¼‰</span>';
  tmp.onclick = ()=>{ currentPlaylist = null; renderFiles(); };
  ul.appendChild(tmp);
}

function renderFiles(){
  const q = document.getElementById('fileSearch').value.toLowerCase();
  const ul = document.getElementById('fileList');
  ul.innerHTML = '';
  let files = (document.getElementById('tempMode').checked || currentPlaylist===null) ? tempQueue : (playlists.find(p=>p.name===currentPlaylist)?.files || []);
  files.filter(f => f.name.toLowerCase().includes(q)).forEach((f,i) => {
    const li = document.createElement('li');
    const span = document.createElement('span'); span.className='name'; span.textContent = f.name; span.onclick = ()=>playFileIndex(i);
    const ren = document.createElement('button'); ren.textContent='âœï¸'; ren.className='small';
    ren.onclick = e => { e.stopPropagation(); const nn = prompt('æ–°ã—ã„æ›²å', f.name); if(nn){ f.name = nn; if(!document.getElementById('tempMode').checked && currentPlaylist){ const pl = playlists.find(p=>p.name===currentPlaylist); if(pl) pl.files = files; savePlaylists(); } renderFiles(); } };
    const del = document.createElement('button'); del.textContent='Ã—'; del.className='danger';
    del.onclick = e => { e.stopPropagation(); if(confirm(`${f.name} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)){ files.splice(i,1); if(!document.getElementById('tempMode').checked && currentPlaylist){ const pl = playlists.find(p=>p.name===currentPlaylist); if(pl) pl.files = files; savePlaylists(); } renderFiles(); } };
    li.append(span, ren, del);
    ul.appendChild(li);
  });

  if(window.fileSortable) window.fileSortable.destroy();
  window.fileSortable = Sortable.create(ul, {
    animation: 150,
    handle: '.name',
    onEnd: function(evt){
      const oldIndex = evt.oldIndex, newIndex = evt.newIndex;
      if(oldIndex===newIndex) return;
      const arr = (document.getElementById('tempMode').checked || currentPlaylist===null) ? tempQueue : (playlists.find(p=>p.name===currentPlaylist)?.files || []);
      const [moved] = arr.splice(oldIndex,1);
      arr.splice(newIndex,0,moved);
      if(!document.getElementById('tempMode').checked && currentPlaylist){
        const pl = playlists.find(p=>p.name===currentPlaylist); if(pl) pl.files = arr; savePlaylists();
      }
      renderFiles();
    }
  });
}

// helpers
function fileToBase64(file){
  return new Promise((res,rej)=>{
    const reader = new FileReader();
    reader.onload = ()=>res(reader.result);
    reader.onerror = rej;
    reader.readAsDataURL(file);
  });
}

function selectPlaylist(name){
  currentPlaylist = name;
  renderFiles();
}

// interactions
document.getElementById('addPlaylist').onclick = ()=>{
  const name = prompt('ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå');
  if(!name) return;
  playlists.push({name, files: []});
  savePlaylists();
  renderPlaylists();
};

document.getElementById('playlistSearch').oninput = renderPlaylists;
document.getElementById('fileSearch').oninput = renderFiles;

document.getElementById('addFilesBtn').onclick = ()=> document.getElementById('fileInput').click();
document.getElementById('fileInput').onchange = async (e) => {
  const files = [...e.target.files];
  if(document.getElementById('tempMode').checked || currentPlaylist===null){
    for(const f of files){ const data = await fileToBase64(f); tempQueue.push({name:f.name, data}); }
    renderFiles();
  } else {
    if(!currentPlaylist){ alert('ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„'); e.target.value=''; return; }
    const pl = playlists.find(p=>p.name===currentPlaylist);
    for(const f of files){ const data = await fileToBase64(f); pl.files.push({name:f.name, data}); }
    savePlaylists(); renderFiles();
  }
  e.target.value = '';
};

document.getElementById('clearTemp').onclick = ()=>{ if(confirm('ä¸€æ™‚ã‚­ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')){ tempQueue = []; renderFiles(); } };

// playback
const player = document.getElementById('player');

function getQueue(){ return (document.getElementById('tempMode').checked || currentPlaylist===null) ? tempQueue : (playlists.find(p=>p.name===currentPlaylist)?.files || []); }

function playFileIndex(i){
  const q = getQueue();
  if(!q || !q[i]) return;
  const item = q[i];
  player.src = item.data;
  player.play().catch(()=>{});
  currentIndex = i;
  ensureAudioContextConnected();
  startKeepAlive(); // try to keep audio running when screen locks
}

document.getElementById('playBtn').onclick = ()=>{ player.play().catch(()=>{}); ensureAudioContextConnected(); startKeepAlive(); };
document.getElementById('pauseBtn').onclick = ()=> { player.pause(); stopKeepAlive(); };
document.getElementById('prevBtn').onclick = ()=> { const q = getQueue(); if(!q || q.length===0) return; currentIndex = (currentIndex - 1 + q.length) % q.length; playFileIndex(currentIndex); };
document.getElementById('nextBtn').onclick = ()=> nextTrack();
document.getElementById('loopBtn').onclick = ()=> { loopMode = !loopMode; player.loop = false; document.getElementById('loopBtn').textContent = `ğŸ” ãƒ«ãƒ¼ãƒ—ï¼š${loopMode ? 'ã‚ªãƒ³' : 'ã‚ªãƒ•'}`; };
document.getElementById('fullscreenBtn').onclick = ()=> { if(player.requestFullscreen) player.requestFullscreen(); else if(player.webkitEnterFullscreen) player.webkitEnterFullscreen(); };

function nextTrack(){
  const q = getQueue();
  if(!q || q.length===0) return;
  if(currentIndex < q.length - 1){ currentIndex++; playFileIndex(currentIndex); }
  else if(loopMode){ currentIndex = 0; playFileIndex(currentIndex); }
}

player.addEventListener('ended', ()=>{ nextTrack(); });

// AudioContext to improve background behavior
function ensureAudioContextConnected(){
  try{
    if(!audioCtx){ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    if(audioCtx.state === 'suspended'){ audioCtx.resume().catch(()=>{}); }
    if(!mediaSource){
      try{ mediaSource = audioCtx.createMediaElementSource(player); mediaSource.connect(audioCtx.destination); }
      catch(e){ /* some browsers block multiple creates */ }
    }
  }catch(e){ console.warn('AudioContext error', e); }
}

// Keep-alive: create a silent looping buffer source attached to AudioContext destination.
// This can help prevent iOS from pausing audio when the device locks in some cases.
function startKeepAlive(){
  try{
    if(!audioCtx) ensureAudioContextConnected();
    if(!audioCtx || keepAliveSource) return;
    // create 1-second silent buffer
    const sampleRate = audioCtx.sampleRate || 44100;
    const buffer = audioCtx.createBuffer(1, sampleRate, sampleRate);
    // buffer is zero-filled by default (silence)
    const src = audioCtx.createBufferSource();
    src.buffer = buffer;
    src.loop = true;
    src.connect(audioCtx.destination);
    // start only after a user gesture (we call this after play())
    try{ src.start(0); keepAliveSource = src; }catch(e){ console.warn('keepAlive start failed', e); }
  }catch(e){ console.warn('startKeepAlive error', e); }
}
function stopKeepAlive(){
  try{
    if(keepAliveSource){ try{ keepAliveSource.stop(); }catch(e){} keepAliveSource.disconnect(); keepAliveSource = null; }
  }catch(e){ console.warn('stopKeepAlive', e); }
}

// Robust background handling
document.addEventListener('visibilitychange', ()=>{
  if(document.hidden){
    // record if playing so we can try to resume on return
    if(!player.paused) resumeOnReturn = true;
    // even if element gets paused by the browser, the AudioContext + keep-alive may keep audio alive
    startHiddenEndedChecker();
  } else {
    if(resumeOnReturn){ player.play().catch(()=>{}); resumeOnReturn = false; }
    stopHiddenEndedChecker();
  }
});
window.addEventListener('pagehide', ()=>{ if(!player.paused) resumeOnReturn = true; startHiddenEndedChecker(); });
window.addEventListener('pageshow', ()=>{ if(resumeOnReturn){ player.play().catch(()=>{}); resumeOnReturn = false; } stopHiddenEndedChecker(); });

function startHiddenEndedChecker(){
  stopHiddenEndedChecker();
  hiddenEndedCheckTimer = setInterval(()=>{
    if(player.duration && player.currentTime >= player.duration - 0.5){
      nextTrack();
    }
  }, 800);
}
function stopHiddenEndedChecker(){ if(hiddenEndedCheckTimer){ clearInterval(hiddenEndedCheckTimer); hiddenEndedCheckTimer = null; } }

// drag-drop file to file list (for convenience)
const fileListEl = document.getElementById('fileList');
['dragover','dragenter'].forEach(ev => fileListEl.addEventListener(ev, e => { e.preventDefault(); fileListEl.style.outline='2px dashed rgba(6,182,212,0.4)'; }));
['dragleave','drop'].forEach(ev => fileListEl.addEventListener(ev, e => { e.preventDefault(); fileListEl.style.outline=''; }));
fileListEl.addEventListener('drop', async e => {
  e.preventDefault();
  const dt = e.dataTransfer;
  if(!dt) return;
  const files = Array.from(dt.files || []);
  if(files.length === 0) return;
  if(document.getElementById('tempMode').checked || currentPlaylist===null){
    for(const f of files){ const data = await fileToBase64(f); tempQueue.push({name:f.name, data}); }
    renderFiles();
  } else {
    const pl = playlists.find(p=>p.name===currentPlaylist);
    for(const f of files){ const data = await fileToBase64(f); pl.files.push({name:f.name, data}); }
    savePlaylists(); renderFiles();
  }
});

// export/import helpers
document.getElementById('exportBtn').onclick = ()=> {
  const data = JSON.stringify(playlists);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'playlists.json'; a.click(); URL.revokeObjectURL(url);
};

// theme toggle
document.getElementById('themeToggle').onclick = ()=>{
  const html = document.documentElement;
  html.dataset.theme = html.dataset.theme === 'light' ? 'dark' : 'light';
  localStorage.setItem('vm-theme', html.dataset.theme);
};

// Service Worker registration (if hosted on http(s))
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js').then(r => {
    console.log('SW registered', r);
  }).catch(err => console.warn('SW failed', err));
}

// initial render
setTimeout(()=>{ renderPlaylists(); renderFiles(); }, 200);
</script>
</body>
</html>
